/*
 * Copyright 2016 The BigDL Authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.intel.analytics.bigdl.nn

import com.intel.analytics.bigdl.tensor.Tensor
import com.intel.analytics.bigdl.utils.{RandomGenerator, T}
import org.scalatest.{FlatSpec, Matchers}

import scala.util.Random

class MaskRCNNC4PredictorSpec extends FlatSpec with Matchers {
  "MaskRCNNC4Predictor" should "be ok" in {
    RandomGenerator.RNG.setSeed(100)

    val input = Tensor[Float](T(T(T(
      T(0.1117, 0.8158, 0.2626, 0.4839, 0.6765, 0.7539, 0.2627, 0.0428),
      T(0.2080, 0.1180, 0.1217, 0.7356, 0.7118, 0.7876, 0.4183, 0.9014),
      T(0.9969, 0.7565, 0.2239, 0.3023, 0.1784, 0.8238, 0.5557, 0.9770),
      T(0.4440, 0.9478, 0.7445, 0.4892, 0.2426, 0.7003, 0.5277, 0.2472),
      T(0.7909, 0.4235, 0.0169, 0.2209, 0.9535, 0.7064, 0.1629, 0.8902),
      T(0.5163, 0.0359, 0.6476, 0.3430, 0.3182, 0.5261, 0.0447, 0.5123),
      T(0.9051, 0.5989, 0.4450, 0.7278, 0.4563, 0.3389, 0.6211, 0.5530),
      T(0.6896, 0.3687, 0.9053, 0.8356, 0.3039, 0.6726, 0.5740, 0.9233)),
      T(T(0.9178, 0.7590, 0.7775, 0.6179, 0.3379, 0.2170, 0.9454, 0.7116),
        T(0.1157, 0.6574, 0.3451, 0.0453, 0.9798, 0.5548, 0.6868, 0.4920),
        T(0.0748, 0.9605, 0.3271, 0.0103, 0.9516, 0.2855, 0.2324, 0.9141),
        T(0.7668, 0.1659, 0.4393, 0.2243, 0.8935, 0.0497, 0.1780, 0.3011),
        T(0.1893, 0.9186, 0.2131, 0.3957, 0.6017, 0.4234, 0.5224, 0.4175),
        T(0.0340, 0.9157, 0.3079, 0.6269, 0.8277, 0.6594, 0.0887, 0.4890),
        T(0.5887, 0.7340, 0.8497, 0.9112, 0.4847, 0.9436, 0.3904, 0.2499),
        T(0.3206, 0.9753, 0.7582, 0.6688, 0.2651, 0.2336, 0.5057, 0.5688)),
      T(T(0.0634, 0.8993, 0.2732, 0.3397, 0.1879, 0.5534, 0.2682, 0.9556),
        T(0.9761, 0.5934, 0.3124, 0.9431, 0.8519, 0.9815, 0.1132, 0.4783),
        T(0.4436, 0.3847, 0.4521, 0.5569, 0.9952, 0.0015, 0.0813, 0.4907),
        T(0.2130, 0.4603, 0.1386, 0.0277, 0.5662, 0.3503, 0.6555, 0.7667),
        T(0.2269, 0.7555, 0.6458, 0.3673, 0.1770, 0.2966, 0.9925, 0.2103),
        T(0.1292, 0.1719, 0.9127, 0.6818, 0.1953, 0.9991, 0.1133, 0.0135),
        T(0.1450, 0.7819, 0.3134, 0.2983, 0.3436, 0.2028, 0.9792, 0.4947),
        T(0.3617, 0.9687, 0.0359, 0.3041, 0.9867, 0.1290, 0.6887, 0.1637))),
      T(T(T(0.0899, 0.3139, 0.1219, 0.3516, 0.2316, 0.2847, 0.3520, 0.2828),
        T(0.2420, 0.4928, 0.5772, 0.3771, 0.2440, 0.8994, 0.1041, 0.9193),
        T(0.6201, 0.3658, 0.0623, 0.5967, 0.0829, 0.8185, 0.4964, 0.0589),
        T(0.9840, 0.5836, 0.6737, 0.4738, 0.9336, 0.2557, 0.1506, 0.7856),
        T(0.4152, 0.5809, 0.1088, 0.7065, 0.0105, 0.4602, 0.2945, 0.0475),
        T(0.6401, 0.3784, 0.5887, 0.0720, 0.9140, 0.0085, 0.2174, 0.1890),
        T(0.0911, 0.6344, 0.3142, 0.7052, 0.6447, 0.9517, 0.3581, 0.3411),
        T(0.0433, 0.4373, 0.9947, 0.1748, 0.1374, 0.8005, 0.7004, 0.8803)),
        T(T(0.1573, 0.3343, 0.9652, 0.1862, 0.1508, 0.3183, 0.0321, 0.3290),
          T(0.5301, 0.6401, 0.7954, 0.3066, 0.2397, 0.1156, 0.4839, 0.3944),
          T(0.0801, 0.7782, 0.6686, 0.2312, 0.1164, 0.1921, 0.2380, 0.1643),
          T(0.1724, 0.8462, 0.1072, 0.7113, 0.1406, 0.2950, 0.3264, 0.4708),
          T(0.3978, 0.7055, 0.9162, 0.8060, 0.7267, 0.8054, 0.1696, 0.2023),
          T(0.9194, 0.0151, 0.0324, 0.9538, 0.5564, 0.7567, 0.1573, 0.3969),
          T(0.2381, 0.1268, 0.4460, 0.0370, 0.6442, 0.8108, 0.2550, 0.8608),
          T(0.8250, 0.2236, 0.0772, 0.4818, 0.0776, 0.0531, 0.2610, 0.1068)),
        T(T(0.3011, 0.4587, 0.5222, 0.0683, 0.9118, 0.8286, 0.1635, 0.1775),
          T(0.7163, 0.9355, 0.1430, 0.3933, 0.1124, 0.3087, 0.9973, 0.4257),
          T(0.6890, 0.9657, 0.0257, 0.4205, 0.0656, 0.4508, 0.0553, 0.3140),
          T(0.7460, 0.9357, 0.8925, 0.1370, 0.1803, 0.4023, 0.4296, 0.3692),
          T(0.1611, 0.9422, 0.8777, 0.5321, 0.5392, 0.1580, 0.6420, 0.6931),
          T(0.0031, 0.6751, 0.1537, 0.5281, 0.1162, 0.4431, 0.2135, 0.2118),
          T(0.6561, 0.3722, 0.3653, 0.7055, 0.0839, 0.1767, 0.7989, 0.9738),
          T(0.2665, 0.1409, 0.7630, 0.9691, 0.3708, 0.0624, 0.5867, 0.7174)))))

    val in_channels: Int = 256 // 3
    val num_classes: Int = 81 // 2
    val dim_reduced: Int = 256 // 10
    val layer = new MaskRCNNC4Predictor(in_channels, num_classes, dim_reduced)
    val params = layer.getParameters()
    params._1.fill(0.01f)

    val output = layer.forward(input).toTensor[Float]

    require(output.size(1) == 2 && output.size(2) == 2 &&
      output.size(3) == 16 && output.size(4) == 16)

    val expectedOutput = Tensor[Float](T(T(T(
      T(0.0121, 0.0121, 0.0135, 0.0135, 0.0123, 0.0123, 0.0124, 0.0124,
      0.0122, 0.0122, 0.0125, 0.0125, 0.0125, 0.0125, 0.0127, 0.0127),
      T(0.0121, 0.0121, 0.0135, 0.0135, 0.0123, 0.0123, 0.0124, 0.0124,
        0.0122, 0.0122, 0.0125, 0.0125, 0.0125, 0.0125, 0.0127, 0.0127),
      T(0.0123, 0.0123, 0.0124, 0.0124, 0.0118, 0.0118, 0.0127, 0.0127,
        0.0135, 0.0135, 0.0133, 0.0133, 0.0122, 0.0122, 0.0129, 0.0129),
      T(0.0123, 0.0123, 0.0124, 0.0124, 0.0118, 0.0118, 0.0127, 0.0127,
        0.0135, 0.0135, 0.0133, 0.0133, 0.0122, 0.0122, 0.0129, 0.0129),
      T(0.0125, 0.0125, 0.0131, 0.0131, 0.0120, 0.0120, 0.0119, 0.0119,
        0.0131, 0.0131, 0.0121, 0.0121, 0.0119, 0.0119, 0.0134, 0.0134),
      T(0.0125, 0.0125, 0.0131, 0.0131, 0.0120, 0.0120, 0.0119, 0.0119,
        0.0131, 0.0131, 0.0121, 0.0121, 0.0119, 0.0119, 0.0134, 0.0134),
      T(0.0124, 0.0124, 0.0126, 0.0126, 0.0123, 0.0123, 0.0117, 0.0117,
        0.0127, 0.0127, 0.0121, 0.0121, 0.0124, 0.0124, 0.0123, 0.0123),
      T(0.0124, 0.0124, 0.0126, 0.0126, 0.0123, 0.0123, 0.0117, 0.0117,
        0.0127, 0.0127, 0.0121, 0.0121, 0.0124, 0.0124, 0.0123, 0.0123),
      T(0.0122, 0.0122, 0.0131, 0.0131, 0.0119, 0.0119, 0.0120, 0.0120,
        0.0127, 0.0127, 0.0124, 0.0124, 0.0127, 0.0127, 0.0125, 0.0125),
      T(0.0122, 0.0122, 0.0131, 0.0131, 0.0119, 0.0119, 0.0120, 0.0120,
        0.0127, 0.0127, 0.0124, 0.0124, 0.0127, 0.0127, 0.0125, 0.0125),
      T(0.0117, 0.0117, 0.0121, 0.0121, 0.0129, 0.0129, 0.0127, 0.0127,
        0.0123, 0.0123, 0.0132, 0.0132, 0.0112, 0.0112, 0.0120, 0.0120),
      T(0.0117, 0.0117, 0.0121, 0.0121, 0.0129, 0.0129, 0.0127, 0.0127,
        0.0123, 0.0123, 0.0132, 0.0132, 0.0112, 0.0112, 0.0120, 0.0120),
      T(0.0126, 0.0126, 0.0131, 0.0131, 0.0126, 0.0126, 0.0129, 0.0129,
        0.0123, 0.0123, 0.0125, 0.0125, 0.0130, 0.0130, 0.0123, 0.0123),
      T(0.0126, 0.0126, 0.0131, 0.0131, 0.0126, 0.0126, 0.0129, 0.0129,
        0.0123, 0.0123, 0.0125, 0.0125, 0.0130, 0.0130, 0.0123, 0.0123),
      T(0.0124, 0.0124, 0.0133, 0.0133, 0.0127, 0.0127, 0.0128, 0.0128,
        0.0126, 0.0126, 0.0120, 0.0120, 0.0128, 0.0128, 0.0127, 0.0127),
      T(0.0124, 0.0124, 0.0133, 0.0133, 0.0127, 0.0127, 0.0128, 0.0128,
        0.0126, 0.0126, 0.0120, 0.0120, 0.0128, 0.0128, 0.0127, 0.0127)),
      T(T(0.0121, 0.0121, 0.0135, 0.0135, 0.0123, 0.0123, 0.0124, 0.0124,
        0.0122, 0.0122, 0.0125, 0.0125, 0.0125, 0.0125, 0.0127, 0.0127),
        T(0.0121, 0.0121, 0.0135, 0.0135, 0.0123, 0.0123, 0.0124, 0.0124,
          0.0122, 0.0122, 0.0125, 0.0125, 0.0125, 0.0125, 0.0127, 0.0127),
        T(0.0123, 0.0123, 0.0124, 0.0124, 0.0118, 0.0118, 0.0127, 0.0127,
          0.0135, 0.0135, 0.0133, 0.0133, 0.0122, 0.0122, 0.0129, 0.0129),
        T(0.0123, 0.0123, 0.0124, 0.0124, 0.0118, 0.0118, 0.0127, 0.0127,
          0.0135, 0.0135, 0.0133, 0.0133, 0.0122, 0.0122, 0.0129, 0.0129),
        T(0.0125, 0.0125, 0.0131, 0.0131, 0.0120, 0.0120, 0.0119, 0.0119,
          0.0131, 0.0131, 0.0121, 0.0121, 0.0119, 0.0119, 0.0134, 0.0134),
        T(0.0125, 0.0125, 0.0131, 0.0131, 0.0120, 0.0120, 0.0119, 0.0119,
          0.0131, 0.0131, 0.0121, 0.0121, 0.0119, 0.0119, 0.0134, 0.0134),
        T(0.0124, 0.0124, 0.0126, 0.0126, 0.0123, 0.0123, 0.0117, 0.0117,
          0.0127, 0.0127, 0.0121, 0.0121, 0.0124, 0.0124, 0.0123, 0.0123),
        T(0.0124, 0.0124, 0.0126, 0.0126, 0.0123, 0.0123, 0.0117, 0.0117,
          0.0127, 0.0127, 0.0121, 0.0121, 0.0124, 0.0124, 0.0123, 0.0123),
        T(0.0122, 0.0122, 0.0131, 0.0131, 0.0119, 0.0119, 0.0120, 0.0120,
          0.0127, 0.0127, 0.0124, 0.0124, 0.0127, 0.0127, 0.0125, 0.0125),
        T(0.0122, 0.0122, 0.0131, 0.0131, 0.0119, 0.0119, 0.0120, 0.0120,
          0.0127, 0.0127, 0.0124, 0.0124, 0.0127, 0.0127, 0.0125, 0.0125),
        T(0.0117, 0.0117, 0.0121, 0.0121, 0.0129, 0.0129, 0.0127, 0.0127,
          0.0123, 0.0123, 0.0132, 0.0132, 0.0112, 0.0112, 0.0120, 0.0120),
        T(0.0117, 0.0117, 0.0121, 0.0121, 0.0129, 0.0129, 0.0127, 0.0127,
          0.0123, 0.0123, 0.0132, 0.0132, 0.0112, 0.0112, 0.0120, 0.0120),
        T(0.0126, 0.0126, 0.0131, 0.0131, 0.0126, 0.0126, 0.0129, 0.0129,
          0.0123, 0.0123, 0.0125, 0.0125, 0.0130, 0.0130, 0.0123, 0.0123),
        T(0.0126, 0.0126, 0.0131, 0.0131, 0.0126, 0.0126, 0.0129, 0.0129,
          0.0123, 0.0123, 0.0125, 0.0125, 0.0130, 0.0130, 0.0123, 0.0123),
        T(0.0124, 0.0124, 0.0133, 0.0133, 0.0127, 0.0127, 0.0128, 0.0128,
          0.0126, 0.0126, 0.0120, 0.0120, 0.0128, 0.0128, 0.0127, 0.0127),
        T(0.0124, 0.0124, 0.0133, 0.0133, 0.0127, 0.0127, 0.0128, 0.0128,
          0.0126, 0.0126, 0.0120, 0.0120, 0.0128, 0.0128, 0.0127, 0.0127))),
      T(T(T(0.0115, 0.0115, 0.0121, 0.0121, 0.0126, 0.0126, 0.0116, 0.0116,
        0.0123, 0.0123, 0.0124, 0.0124, 0.0115, 0.0115, 0.0118, 0.0118),
        T(0.0115, 0.0115, 0.0121, 0.0121, 0.0126, 0.0126, 0.0116, 0.0116,
          0.0123, 0.0123, 0.0124, 0.0124, 0.0115, 0.0115, 0.0118, 0.0118),
        T(0.0125, 0.0125, 0.0131, 0.0131, 0.0125, 0.0125, 0.0121, 0.0121,
          0.0116, 0.0116, 0.0123, 0.0123, 0.0126, 0.0126, 0.0127, 0.0127),
        T(0.0125, 0.0125, 0.0131, 0.0131, 0.0125, 0.0125, 0.0121, 0.0121,
          0.0116, 0.0116, 0.0123, 0.0123, 0.0126, 0.0126, 0.0127, 0.0127),
        T(0.0124, 0.0124, 0.0131, 0.0131, 0.0118, 0.0118, 0.0122, 0.0122,
          0.0113, 0.0113, 0.0125, 0.0125, 0.0118, 0.0118, 0.0115, 0.0115),
        T(0.0124, 0.0124, 0.0131, 0.0131, 0.0118, 0.0118, 0.0122, 0.0122,
          0.0113, 0.0113, 0.0125, 0.0125, 0.0118, 0.0118, 0.0115, 0.0115),
        T(0.0129, 0.0129, 0.0134, 0.0134, 0.0127, 0.0127, 0.0123, 0.0123,
          0.0123, 0.0123, 0.0120, 0.0120, 0.0119, 0.0119, 0.0126, 0.0126),
        T(0.0129, 0.0129, 0.0134, 0.0134, 0.0127, 0.0127, 0.0123, 0.0123,
          0.0123, 0.0123, 0.0120, 0.0120, 0.0119, 0.0119, 0.0126, 0.0126),
        T(0.0120, 0.0120, 0.0132, 0.0132, 0.0129, 0.0129, 0.0130, 0.0130,
          0.0123, 0.0123, 0.0124, 0.0124, 0.0121, 0.0121, 0.0119, 0.0119),
        T(0.0120, 0.0120, 0.0132, 0.0132, 0.0129, 0.0129, 0.0130, 0.0130,
          0.0123, 0.0123, 0.0124, 0.0124, 0.0121, 0.0121, 0.0119, 0.0119),
        T(0.0126, 0.0126, 0.0121, 0.0121, 0.0118, 0.0118, 0.0126, 0.0126,
          0.0126, 0.0126, 0.0122, 0.0122, 0.0116, 0.0116, 0.0118, 0.0118),
        T(0.0126, 0.0126, 0.0121, 0.0121, 0.0118, 0.0118, 0.0126, 0.0126,
          0.0126, 0.0126, 0.0122, 0.0122, 0.0116, 0.0116, 0.0118, 0.0118),
        T(0.0120, 0.0120, 0.0121, 0.0121, 0.0121, 0.0121, 0.0124, 0.0124,
          0.0124, 0.0124, 0.0129, 0.0129, 0.0124, 0.0124, 0.0132, 0.0132),
        T(0.0120, 0.0120, 0.0121, 0.0121, 0.0121, 0.0121, 0.0124, 0.0124,
          0.0124, 0.0124, 0.0129, 0.0129, 0.0124, 0.0124, 0.0132, 0.0132),
        T(0.0121, 0.0121, 0.0118, 0.0118, 0.0128, 0.0128, 0.0126, 0.0126,
          0.0116, 0.0116, 0.0119, 0.0119, 0.0125, 0.0125, 0.0127, 0.0127),
        T(0.0121, 0.0121, 0.0118, 0.0118, 0.0128, 0.0128, 0.0126, 0.0126,
          0.0116, 0.0116, 0.0119, 0.0119, 0.0125, 0.0125, 0.0127, 0.0127)),
        T(T(0.0115, 0.0115, 0.0121, 0.0121, 0.0126, 0.0126, 0.0116, 0.0116,
          0.0123, 0.0123, 0.0124, 0.0124, 0.0115, 0.0115, 0.0118, 0.0118),
          T(0.0115, 0.0115, 0.0121, 0.0121, 0.0126, 0.0126, 0.0116, 0.0116,
            0.0123, 0.0123, 0.0124, 0.0124, 0.0115, 0.0115, 0.0118, 0.0118),
          T(0.0125, 0.0125, 0.0131, 0.0131, 0.0125, 0.0125, 0.0121, 0.0121,
            0.0116, 0.0116, 0.0123, 0.0123, 0.0126, 0.0126, 0.0127, 0.0127),
          T(0.0125, 0.0125, 0.0131, 0.0131, 0.0125, 0.0125, 0.0121, 0.0121,
            0.0116, 0.0116, 0.0123, 0.0123, 0.0126, 0.0126, 0.0127, 0.0127),
          T(0.0124, 0.0124, 0.0131, 0.0131, 0.0118, 0.0118, 0.0122, 0.0122,
            0.0113, 0.0113, 0.0125, 0.0125, 0.0118, 0.0118, 0.0115, 0.0115),
          T(0.0124, 0.0124, 0.0131, 0.0131, 0.0118, 0.0118, 0.0122, 0.0122,
            0.0113, 0.0113, 0.0125, 0.0125, 0.0118, 0.0118, 0.0115, 0.0115),
          T(0.0129, 0.0129, 0.0134, 0.0134, 0.0127, 0.0127, 0.0123, 0.0123,
            0.0123, 0.0123, 0.0120, 0.0120, 0.0119, 0.0119, 0.0126, 0.0126),
          T(0.0129, 0.0129, 0.0134, 0.0134, 0.0127, 0.0127, 0.0123, 0.0123,
            0.0123, 0.0123, 0.0120, 0.0120, 0.0119, 0.0119, 0.0126, 0.0126),
          T(0.0120, 0.0120, 0.0132, 0.0132, 0.0129, 0.0129, 0.0130, 0.0130,
            0.0123, 0.0123, 0.0124, 0.0124, 0.0121, 0.0121, 0.0119, 0.0119),
          T(0.0120, 0.0120, 0.0132, 0.0132, 0.0129, 0.0129, 0.0130, 0.0130,
            0.0123, 0.0123, 0.0124, 0.0124, 0.0121, 0.0121, 0.0119, 0.0119),
          T(0.0126, 0.0126, 0.0121, 0.0121, 0.0118, 0.0118, 0.0126, 0.0126,
            0.0126, 0.0126, 0.0122, 0.0122, 0.0116, 0.0116, 0.0118, 0.0118),
          T(0.0126, 0.0126, 0.0121, 0.0121, 0.0118, 0.0118, 0.0126, 0.0126,
            0.0126, 0.0126, 0.0122, 0.0122, 0.0116, 0.0116, 0.0118, 0.0118),
          T(0.0120, 0.0120, 0.0121, 0.0121, 0.0121, 0.0121, 0.0124, 0.0124,
            0.0124, 0.0124, 0.0129, 0.0129, 0.0124, 0.0124, 0.0132, 0.0132),
          T(0.0120, 0.0120, 0.0121, 0.0121, 0.0121, 0.0121, 0.0124, 0.0124,
            0.0124, 0.0124, 0.0129, 0.0129, 0.0124, 0.0124, 0.0132, 0.0132),
          T(0.0121, 0.0121, 0.0118, 0.0118, 0.0128, 0.0128, 0.0126, 0.0126,
            0.0116, 0.0116, 0.0119, 0.0119, 0.0125, 0.0125, 0.0127, 0.0127),
          T(0.0121, 0.0121, 0.0118, 0.0118, 0.0128, 0.0128, 0.0126, 0.0126,
            0.0116, 0.0116, 0.0119, 0.0119, 0.0125, 0.0125, 0.0127, 0.0127)))))

    output.almostEqual(expectedOutput, 1e-4) should be(true)
  }

  "kaiming_normal" should "be same" in {
    val tmp = Tensor[Float](2, 3)
    RandomGenerator.RNG.setSeed(100)
    val t = MsraFiller(false)
    t.init(tmp, VariableFormat.IN_OUT)

    println("done")
  }
}
