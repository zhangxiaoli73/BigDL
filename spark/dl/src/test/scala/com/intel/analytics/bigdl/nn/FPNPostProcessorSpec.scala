/*
 * Copyright 2016 The BigDL Authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.intel.analytics.bigdl.nn

import com.intel.analytics.bigdl.tensor.Tensor
import com.intel.analytics.bigdl.transform.vision.image.util.{BboxUtil, BoundingBox}
import com.intel.analytics.bigdl.utils.T
import org.dmg.pmml.False
import org.scalatest.{BeforeAndAfter, FlatSpec, Matchers}

class FPNPostProcessorSpec extends FlatSpec with Matchers {

  "FPNPostProcessor" should "be ok" in {
    val score_thresh: Float = 0.05f
    val nms_thresh: Float = 0.5f
    val detections_per_img: Int = 100
    val cls_agnostic_bbox_reg: Boolean = false
    val bbox_aug_enabled: Boolean = false

    val input1 = Tensor[Float](T(
      T(-0.0528, -0.0655,  0.0210, -0.0236,  0.0304,  0.0539,  0.0205, -0.0206,
      0.0193,  0.0102, -0.0113, -0.0410,  0.0137,  0.0221,  0.0177,  0.0281,
      0.0170, -0.0221, -0.0169, -0.0192, -0.0067,  0.0034, -0.0007, -0.0145,
      -0.0284,  0.0241, -0.0102,  0.0215,  0.0540, -0.0031,  0.0354,  0.0144,
      -0.0344, -0.0072, -0.0043, -0.0095,  0.0070, -0.0351,  0.0069,  0.0278,
      0.0066,  0.0029, -0.0182, -0.0384, -0.0035,  0.0164, -0.0298,  0.0142,
      -0.0271,  0.0079,  0.0004,  0.0110,  0.0131, -0.0070, -0.0395, -0.0311,
      0.0047, -0.0249,  0.0003, -0.0099, -0.0135, -0.0135,  0.0331, -0.0057,
      0.0182, -0.0398,  0.0186,  0.0384,  0.0094, -0.0281, -0.0142,  0.0150,
      -0.0122,  0.0196,  0.0477, -0.0283, -0.0273, -0.0093,  0.0181,  0.0411, 0.0029),
      T(-0.0607, -0.0839,  0.0465, -0.0258,  0.0330,  0.0615,  0.0298, -0.0318,
        0.0391,  0.0199, -0.0182, -0.0317,  0.0316,  0.0245,  0.0175,  0.0272,
        0.0250, -0.0411, -0.0105, -0.0174, -0.0038,  0.0135,  0.0017, -0.0221,
        -0.0248,  0.0229, -0.0129,  0.0321,  0.0556,  0.0039,  0.0448,  0.0231,
        -0.0411, -0.0061,  0.0040, -0.0158, -0.0027, -0.0350,  0.0063,  0.0209,
        0.0116, -0.0050,  0.0071, -0.0349, -0.0168,  0.0377, -0.0245,  0.0073,
        -0.0187,  0.0115,  0.0029,  0.0075,  0.0254, -0.0056, -0.0389, -0.0365,
        0.0047, -0.0402, -0.0094, -0.0084, -0.0103, -0.0152,  0.0224,  0.0078,
        0.0258, -0.0352,  0.0133,  0.0468,  0.0049, -0.0433, -0.0069,  0.0180,
        0.0071,  0.0202,  0.0644, -0.0318, -0.0327,  0.0063,  0.0190,  0.0375, -0.0056)))

    val input2 = Tensor[Float](T(
      T(1.2547e-04,  1.3180e-03,  6.2370e-03, -5.0890e-04, -2.6153e-03,
      -1.3165e-03, -7.7025e-05,  4.3028e-03, -2.3636e-03, -3.5590e-03,
      3.0244e-03, -2.8263e-04, -1.4246e-03,  1.7372e-03, -2.0461e-03,
      -5.1238e-04,  2.5481e-03, -1.0470e-03,  2.6192e-04, -4.5874e-03,
      2.7446e-04, -7.4885e-03,  4.0601e-03, -3.8246e-03, -1.8869e-04,
      -5.6163e-04, -3.4610e-03, -4.3590e-03, -2.2148e-04, -7.2285e-05,
      6.6384e-04,  9.8126e-04,  8.6726e-04, -5.3341e-03,  3.7110e-04,
      -3.6599e-03, -1.5917e-03, -6.2317e-03,  2.3629e-03, -1.0170e-03,
      -1.1190e-03, -5.7000e-05, -1.9603e-03,  7.4092e-04, -4.1113e-04,
      3.3686e-03,  2.0960e-03,  6.7256e-04, -4.7453e-04, -8.5099e-03,
      -6.8604e-03, -1.7202e-03, -3.6288e-03, -2.7019e-03, -3.9469e-03,
      -1.8690e-03, -8.1173e-04,  4.8375e-04,  3.2714e-04, -3.6870e-03,
      3.0509e-03, -1.7746e-03,  1.3610e-03,  4.0934e-03,  1.8814e-03,
      1.0661e-04, -3.1919e-03, -3.1101e-03, -3.2069e-05, -1.9496e-03,
      -1.1305e-03, -2.0706e-03,  1.2004e-03,  3.5999e-04, -1.1997e-03,
      1.2142e-03,  2.5322e-03, -3.5478e-03, -9.4953e-04, -3.8600e-03,
      5.5009e-04,  4.1875e-03,  2.6525e-03,  1.8470e-03, -1.5804e-03,
      -2.3700e-03, -4.4702e-03,  1.5000e-03, -2.1067e-03, -8.2335e-04,
      -5.8987e-04, -3.7969e-04,  4.1929e-04, -1.0704e-03,  6.8700e-04,
      -9.1043e-04, -1.8597e-03, -3.1535e-03, -1.9745e-03, -3.3934e-03,
      -3.4488e-03, -3.5896e-03, -4.1041e-04,  1.2471e-03, -3.2536e-03,
      -2.7781e-03,  4.3688e-03, -1.3853e-03,  3.6649e-03, -3.0219e-04,
      7.2934e-04,  2.6153e-05,  4.5653e-04,  1.8671e-03, -3.0123e-04,
      -1.0145e-03, -1.5652e-03, -2.7175e-03, -1.3560e-03, -8.6581e-04,
      -1.2318e-03, -5.7794e-03,  1.8507e-03,  7.0207e-04,  2.5725e-04,
      -1.8590e-03, -3.4898e-03,  3.1864e-03, -2.7901e-03, -3.9743e-03,
      -1.8329e-04, -1.1244e-03, -3.0022e-04, -7.1399e-04,  1.3607e-03,
      -6.1945e-03,  5.7463e-03,  2.5205e-03, -9.9873e-04, -3.0996e-03,
      -1.4434e-03, -3.7868e-03, -4.7267e-03, -5.2086e-03,  2.6148e-03,
      1.6013e-03,  5.3207e-03,  5.8119e-04, -1.1772e-03,  1.1398e-04,
      -2.4140e-03,  7.4481e-04,  1.6567e-03, -4.5060e-03, -1.9124e-03,
      -5.3363e-03,  4.1623e-04, -2.4256e-03,  5.2634e-04, -2.5097e-03,
      -5.6461e-04, -1.7744e-06, -1.5488e-03,  1.9109e-03, -2.0331e-03,
      -8.4710e-04, -1.5173e-04, -1.0355e-03, -2.2363e-03, -3.3267e-03,
      -1.7480e-04,  2.9302e-03, -3.8510e-03,  2.1867e-03, -2.1955e-03,
      -1.9767e-03,  1.6668e-04,  2.3617e-03, -9.6806e-04, -8.9541e-04,
      9.8058e-04,  2.8194e-04,  2.4970e-03, -1.5939e-03,  1.7911e-03,
      7.9169e-04, -1.8732e-04,  2.9243e-03,  1.0848e-03, -2.4439e-03,
      2.2703e-03,  4.1261e-03, -6.7240e-03, -5.8238e-04,  3.9993e-03,
      -5.8518e-04,  1.7747e-03,  2.2055e-03,  1.2058e-03, -1.9879e-03,
      2.2771e-03,  3.2529e-03, -2.4272e-03, -5.3428e-03, -3.0797e-03,
      -3.9725e-03, -2.0866e-03, -3.0151e-03, -1.3349e-03,  1.1952e-04,
      8.4809e-04, -1.3335e-03,  1.6291e-03,  2.6560e-03, -3.2451e-03,
      6.3419e-03, -7.8543e-04,  2.1343e-03,  5.4681e-04, -9.9867e-04,
      -6.4662e-03,  2.5444e-03,  1.8487e-03, -9.1505e-04, -6.0683e-04,
      1.1152e-03, -1.9008e-03, -1.1936e-03, -4.1405e-03, -1.6007e-03,
      2.5440e-03,  1.7949e-03, -3.5139e-03, -2.3631e-03, -3.4074e-03,
      -3.6473e-04,  2.4223e-03, -4.3325e-05,  6.6050e-04,  3.8668e-03,
      -1.5435e-03, -4.3313e-03,  4.7613e-05,  2.3067e-03, -1.1187e-03,
      2.6942e-03, -2.2420e-03,  9.8901e-04,  1.2066e-03, -1.7490e-03,
      -2.8142e-03,  8.8403e-04, -1.5011e-03, -8.4006e-05,  3.3641e-03,
      1.3462e-04, -5.1158e-04,  2.2294e-03, -3.6063e-03, -4.6227e-03,
      -7.5198e-04,  2.6893e-05, -7.6683e-04,  6.8989e-04, -6.6826e-04,
      -1.4900e-03,  1.0988e-03,  1.1232e-03, -4.2167e-03,  2.8338e-03,
      4.5330e-03, -5.5163e-04, -3.4200e-03, -2.3059e-03, -8.8648e-04,
      -2.5544e-03,  1.8715e-03, -6.5712e-04, -1.0842e-03, -4.4011e-03,
      -4.8931e-03, -6.1327e-04, -5.5561e-03,  4.2332e-03, -1.0610e-03,
      2.7961e-04, -8.0012e-04, -6.1453e-06,  1.0649e-03, -5.2977e-03,
      -3.9317e-03, -5.2246e-03,  3.7472e-03, -2.0485e-03, -4.9102e-03,
      -1.7684e-04,  2.4095e-04, -5.2979e-04,  1.8817e-03, -1.7311e-03,
      6.6962e-04,  3.8880e-03,  1.3622e-03,  5.6563e-04,  2.5267e-03,
      -7.0162e-04,  9.9567e-04, -4.6943e-03, -2.6881e-03, -2.0852e-03,
      -3.2363e-03, -2.1857e-03, -6.0548e-04,  2.8350e-03,  3.3523e-03,
      -5.6042e-04,  1.3532e-03,  3.8028e-03, -2.0392e-03,  4.9505e-03,
      -3.0452e-03,  1.1829e-03,  1.7991e-03, -4.0136e-03),
      T(-3.8151e-04,  4.5916e-04,  7.2216e-03,  1.6524e-03, -2.1517e-03,
        -1.7142e-04,  2.3043e-04,  5.2298e-03, -1.8294e-03, -4.3029e-03,
        3.4370e-03, -5.1266e-04, -1.7894e-03,  2.0899e-03, -3.4736e-04,
        -1.9172e-03,  2.9115e-03, -3.5623e-04, -4.9033e-04, -5.0919e-03,
        -7.8984e-04, -8.3909e-03,  4.7718e-03, -4.0685e-03,  4.3845e-05,
        -1.5555e-03, -3.9894e-03, -5.9163e-03,  8.5862e-04,  1.5850e-04,
        1.0105e-03,  1.0443e-03,  7.3303e-04, -7.1319e-03,  1.0061e-03,
        -4.1571e-03, -1.8867e-03, -6.8725e-03,  2.9443e-03, -1.7743e-03,
        -9.4784e-04, -8.2571e-04, -1.8636e-03,  7.4623e-04, -9.5193e-04,
        4.2232e-03,  4.6671e-04,  2.5017e-03,  5.4434e-04, -9.4216e-03,
        -7.1586e-03, -1.3388e-03, -5.7878e-03, -2.9447e-03, -3.8578e-03,
        -1.9441e-03, -1.5706e-03,  5.7911e-04,  5.4366e-04, -4.1621e-03,
        4.7838e-03, -2.1569e-03,  7.0980e-04,  3.3229e-03,  2.7565e-03,
        -1.0463e-03, -2.5594e-03, -3.5401e-03, -8.3204e-05, -3.0557e-04,
        -2.2076e-03, -1.5366e-03,  1.4174e-03, -1.8350e-03, -1.2513e-03,
        2.2268e-03,  3.5314e-03, -3.0468e-03, -5.2363e-04, -3.7137e-03,
        2.8601e-03,  4.1313e-03,  3.3950e-03,  2.1851e-03, -3.6829e-03,
        -1.3376e-03, -4.4806e-03,  1.6112e-03, -2.2764e-03,  1.1388e-03,
        -4.1688e-04, -9.8302e-04, -1.1034e-03, -9.4393e-05,  1.8231e-03,
        -3.3224e-04, -1.6604e-03, -3.5839e-03, -7.5806e-04, -3.8569e-03,
        -5.1578e-03, -4.2717e-03,  2.4337e-03,  1.0395e-03, -2.3169e-03,
        -4.2825e-03,  3.9096e-03, -2.2783e-03,  3.0404e-03, -1.3094e-03,
        -8.8270e-04,  2.0582e-03,  4.5275e-05,  2.5770e-03, -1.6905e-04,
        3.6209e-04, -2.0340e-03, -3.8255e-03, -2.3881e-03, -1.1846e-03,
        -2.7321e-03, -6.2272e-03,  2.7176e-03,  1.6172e-03,  2.1875e-03,
        -1.1975e-03, -4.2350e-03,  2.6173e-03, -2.2742e-03, -5.5036e-03,
        -1.7773e-03, -2.0524e-03, -6.4782e-04, -1.7108e-03,  1.9265e-03,
        -7.6450e-03,  6.4372e-03,  1.5869e-03, -1.6941e-03, -3.5774e-03,
        -2.6147e-03, -3.2535e-03, -4.2110e-03, -4.9536e-03,  3.5979e-03,
        2.2648e-03,  4.7786e-03,  3.0771e-03, -2.7522e-03,  7.3139e-06,
        -2.5288e-03,  2.2877e-03,  2.3288e-03, -3.5635e-03, -2.3039e-03,
        -6.3346e-03,  5.8616e-05, -3.5463e-03, -6.0124e-04, -3.9845e-03,
        -4.5986e-04,  2.2118e-03, -1.8769e-03,  2.2506e-03, -2.3816e-03,
        -1.8786e-03,  4.4653e-04, -1.5864e-04, -2.0503e-03, -4.8448e-03,
        -6.1655e-04,  1.4725e-03, -2.6914e-03,  3.1877e-03, -1.6765e-03,
        -2.7342e-03,  1.4385e-04,  1.2240e-03, -2.1591e-03, -3.3786e-03,
        -4.8203e-04,  5.7407e-04,  3.4411e-03, -1.2131e-03,  2.1162e-04,
        -7.1395e-05, -9.6892e-04,  5.1899e-03,  2.9448e-03, -1.3484e-03,
        3.8788e-03,  2.5929e-03, -8.2051e-03, -2.0183e-03,  3.8629e-03,
        -8.8586e-04,  1.6901e-03,  2.0590e-03,  1.2419e-03, -9.8078e-04,
        -5.2457e-04,  3.7243e-03, -1.6736e-03, -5.7571e-03, -2.8407e-03,
        -5.0761e-03, -2.9211e-03, -3.1361e-03, -2.6441e-03,  3.7506e-04,
        1.4749e-04, -2.8327e-03,  2.3940e-03,  3.2698e-03, -3.8985e-03,
        8.3197e-03, -1.7487e-03,  3.2703e-03,  1.0544e-03, -5.8737e-04,
        -6.7221e-03,  2.6330e-03,  9.7796e-04, -1.9253e-04,  1.6262e-04,
        1.0755e-03, -8.6950e-04, -1.4318e-03, -3.9401e-03, -2.6725e-03,
        4.4849e-03,  2.4894e-03, -4.2844e-03, -2.6086e-03, -3.9916e-03,
        -1.1388e-03,  3.8936e-03, -3.3872e-04,  1.1594e-03,  5.2593e-03,
        -1.4818e-03, -3.3955e-03, -1.6063e-03,  3.8347e-03, -3.3131e-03,
        2.6213e-03, -1.0170e-03,  1.9123e-03,  1.6123e-03, -5.0714e-04,
        -3.2306e-03,  9.5459e-04, -3.3374e-04, -1.0957e-03,  3.5736e-03,
        -4.0108e-04, -8.2558e-04,  2.1009e-03, -3.1349e-03, -6.1256e-03,
        -1.5860e-03, -9.5273e-04,  8.1137e-05,  7.5751e-04, -2.5736e-04,
        -3.7939e-03,  2.7477e-05,  3.1675e-03, -5.9466e-03,  2.3588e-03,
        3.4690e-03, -5.6421e-04, -5.3533e-03, -4.5290e-03, -2.4467e-03,
        -3.4938e-03,  1.4770e-03, -1.1440e-03, -1.3769e-03, -6.0549e-03,
        -4.1708e-03, -6.7729e-04, -6.5952e-03,  4.8243e-03, -1.5407e-03,
        -8.3810e-04, -1.7264e-04, -6.0035e-04,  3.2877e-03, -7.1628e-03,
        -5.9375e-03, -6.6174e-03,  4.3117e-03, -1.6078e-03, -6.1852e-03,
        8.3503e-04,  1.0502e-03, -1.3511e-03,  3.0879e-03, -2.1045e-03,
        3.9012e-04,  5.3002e-03,  1.5866e-03, -3.8507e-04,  2.6121e-03,
        -3.6971e-04,  6.9879e-04, -6.2640e-03, -4.7607e-03, -1.0902e-03,
        -5.1047e-03, -1.7955e-03, -1.5077e-03,  3.0722e-03,  2.5561e-03,
        1.6600e-05,  1.5761e-03,  4.0219e-03, -2.3948e-03,  5.0930e-03,
        -2.7311e-03,  1.2098e-03,  1.0574e-03, -5.9505e-03)))

    val imageInfo = Tensor[Float](T(10, 15))
    val bbox = Tensor[Float](T(T(1.0f, 3.0f, 2.0f, 6.0f), T(3.0f, 5.0f, 6.0f, 10.0f)))

    val layer = new FPNPostProcessor(score_thresh, nms_thresh, detections_per_img,
      cls_agnostic_bbox_reg, bbox_aug_enabled)

    val output = layer.forward(T(input1, input2, bbox))

    println("done")
  }

  "boxdecoder" should "be ok" in {

    val input2 = Tensor[Float](T(
      T(1.3661e-02, -1.5969e-02, -5.9290e-03,  1.8143e-02,  1.6237e-02,
        1.3777e-02,  1.7327e-02,  2.7747e-03,  2.3234e-03, -2.4683e-02,
        -4.6764e-03, -1.5181e-02,  2.2511e-03, -1.0680e-02, -8.6638e-03,
        -8.1392e-04,  4.3010e-03,  2.2984e-03, -1.1075e-04,  2.5192e-03,
        3.7293e-03,  4.5914e-03,  7.4328e-04,  1.3598e-02,  2.1697e-02,
        -1.2982e-02, -2.7786e-03, -5.5487e-03, -1.4818e-02, -6.6994e-03,
        7.2817e-05,  1.7714e-02,  9.4883e-03, -1.3120e-02,  8.2604e-03,
        -2.5319e-04,  2.0901e-03, -1.5276e-03,  3.0417e-03,  6.4315e-03,
        -2.0766e-02,  1.7414e-02, -1.2154e-02,  8.9248e-03,  2.8219e-03,
        8.8979e-03, -1.6514e-02, -5.6355e-03,  1.6068e-02,  4.5205e-03,
        1.6125e-03, -7.3517e-03,  1.8342e-02, -6.5888e-05, -2.1047e-04,
        -9.0755e-04, -8.0835e-03,  2.9841e-03,  1.3073e-02, -3.6516e-03,
        1.2379e-02,  1.2722e-02, -2.4802e-03, -1.9914e-02, -6.1535e-04,
        -8.5233e-03,  6.6699e-03,  2.1765e-03, -3.8606e-03,  7.3144e-03,
        -1.8051e-03,  4.9700e-03, -1.1121e-02,  4.1682e-03, -8.6669e-03,
        -9.2954e-04,  3.7563e-04, -6.9444e-03,  1.4729e-03,  6.4981e-03,
        7.7078e-03,  8.9667e-03, -3.6054e-03, -1.6158e-02, -6.5347e-03,
        1.4964e-02, -7.3836e-03, -2.5321e-03,  3.9948e-03, -5.4285e-04,
        -1.5295e-02,  2.7546e-03, -8.4908e-03, -4.6551e-03,  5.5927e-04,
        1.5543e-02, -4.7723e-03,  1.0493e-02,  6.4895e-03,  1.4147e-02,
        -1.8565e-02, -1.9299e-02,  9.7874e-04,  1.4433e-02, -2.1955e-03,
        1.6294e-02,  1.3044e-02, -9.5193e-03, -6.6752e-03, -9.5884e-04,
        2.9285e-03, -9.7279e-03,  1.4390e-02,  6.0092e-03,  5.0495e-03,
        -3.8071e-03,  1.9877e-03,  4.2515e-03, -1.5387e-02, -1.6682e-02,
        -6.0809e-03, -1.1329e-02, -6.7931e-03,  1.6494e-02,  4.9138e-03,
        -1.2627e-03,  1.4018e-02,  3.5096e-04, -8.4504e-04, -9.2940e-03,
        4.2522e-03, -2.3363e-02,  6.3998e-03,  2.2115e-03, -9.9258e-03,
        -7.0226e-03,  6.2844e-03, -1.1065e-02, -1.3531e-02,  2.1513e-03,
        5.6689e-03, -1.0604e-03,  5.6464e-03, -6.4182e-03, -7.1815e-03,
        -1.4931e-02, -8.3965e-04, -9.3323e-03, -1.8467e-03, -1.0281e-03,
        -6.5093e-03,  3.2346e-03, -4.3760e-03, -1.9013e-02,  1.0435e-02,
        1.5070e-02,  4.2301e-03,  1.6412e-03, -1.7103e-02, -6.4496e-03,
        -3.8278e-03,  3.6479e-03, -2.8994e-03,  1.6793e-02, -2.9968e-03,
        3.1172e-03,  2.5375e-03,  7.0270e-03,  3.6239e-03, -7.0860e-03,
        -1.8149e-02, -3.7942e-03, -1.2530e-02, -1.1264e-02, -3.3323e-03,
        3.4543e-03,  1.0063e-02, -3.6748e-03,  1.4239e-02, -7.5735e-03,
        7.3133e-03, -1.9782e-03, -2.2172e-03, -1.0912e-03, -3.7825e-03,
        -7.4081e-04,  4.5590e-03,  5.3438e-03, -2.0137e-02, -1.9620e-03,
        6.2416e-03,  4.0682e-03,  1.3567e-03, -9.5075e-04,  4.6717e-04,
        -1.7814e-02, -7.7103e-04, -1.0783e-03,  1.3706e-02,  7.0475e-04,
        -4.9925e-04,  8.7880e-04, -1.7428e-02, -8.9522e-03,  3.8191e-03,
        2.9673e-03,  9.2092e-03,  4.4823e-03, -5.5942e-03,  3.2957e-03,
        1.7243e-02,  1.2292e-02,  2.9729e-03,  1.2354e-02, -2.6377e-03,
        -5.8388e-04, -6.0909e-03,  1.9190e-03, -1.5601e-03,  2.6388e-03,
        1.6506e-02, -1.2885e-03,  3.3878e-03,  2.5893e-02, -5.4612e-05,
        6.4574e-03, -2.3816e-03,  9.2435e-03, -6.6578e-03,  5.4547e-03,
        1.5704e-03, -2.0293e-03, -2.6737e-03,  8.7105e-03,  2.1711e-02,
        -2.4641e-02,  6.1686e-03,  8.8161e-04, -3.0827e-03, -8.8028e-03,
        6.9194e-03,  8.3028e-04, -1.0538e-02, -2.9566e-03, -1.2682e-02,
        9.2352e-03,  5.3863e-03,  7.6400e-03,  2.2716e-03, -8.4753e-03,
        -1.1846e-02,  2.5826e-02, -6.1796e-03, -2.9242e-03,  1.4730e-03,
        -1.3617e-02,  6.2193e-03,  1.9359e-02,  8.1467e-04,  5.5846e-03,
        -1.4939e-02,  1.0488e-02, -1.8130e-03,  5.7163e-03, -6.2896e-03,
        -5.6848e-03,  8.5823e-03,  7.5564e-03,  3.7059e-03,  7.8826e-03,
        2.0233e-03,  4.2189e-03,  2.7457e-03, -9.6326e-03, -3.5484e-03,
        -3.7892e-04, -9.1349e-03, -2.7773e-03, -1.9159e-03,  3.8842e-03,
        1.2862e-02, -4.7707e-03,  3.5862e-03,  1.2511e-02,  1.3060e-03,
        -3.8291e-03,  1.6206e-03,  2.5615e-03,  1.1594e-03, -8.1862e-03,
        -7.3836e-03, -1.4762e-02,  1.4097e-02, -2.9509e-03,  1.8827e-02,
        -4.2922e-03, -2.3085e-03,  4.6543e-03,  1.9951e-03, -3.1339e-03,
        -2.9166e-03,  4.1162e-03, -1.9522e-02, -1.4711e-02,  5.7154e-04,
        -1.3359e-02,  1.6769e-02,  5.1254e-03,  2.4062e-04,  5.0682e-03,
        -3.3154e-03,  1.1630e-02,  1.1256e-02, -1.2214e-02,  1.2074e-02,
        1.1045e-02,  3.1662e-03, -3.9489e-03, -1.1755e-03, -2.0921e-02,
        8.7897e-04,  6.8785e-03,  7.2665e-03,  2.4340e-03),
      T( 1.2621e-02, -2.1212e-02, -4.8419e-03,  1.8352e-02,  1.4309e-02,
        7.7016e-03,  1.5640e-02,  3.5949e-03,  1.7785e-03, -2.3214e-02,
        -3.1563e-03, -1.2737e-02,  2.2589e-03, -1.2418e-02, -5.2792e-03,
        -2.9588e-03,  5.2810e-03,  6.9386e-03,  2.4073e-03,  1.5306e-03,
        3.1790e-03,  6.7547e-03,  2.5636e-03,  1.6852e-02,  2.0628e-02,
        -1.6845e-02, -5.7982e-04, -6.6146e-03, -9.2885e-03, -3.6907e-03,
        3.4162e-03,  1.5163e-02,  5.6014e-03, -1.3949e-02,  5.7968e-03,
        1.7021e-03,  6.8812e-03,  1.5124e-04,  5.0120e-03,  6.8222e-03,
        -1.5536e-02,  1.5584e-02, -1.4665e-02,  7.6578e-03,  6.4390e-03,
        7.9877e-03, -1.6974e-02, -5.0131e-03,  1.9200e-02,  5.7378e-03,
        -2.1136e-03, -7.0412e-03,  1.7766e-02, -2.5316e-03, -4.5450e-03,
        1.7952e-03, -1.0353e-02,  6.4365e-04,  1.3593e-02, -8.1278e-03,
        1.4217e-02,  8.3415e-03, -2.2200e-03, -1.9228e-02,  7.6278e-04,
        -1.0273e-02,  8.6297e-03, -2.1147e-03, -2.6936e-03,  9.8119e-03,
        -3.7311e-04,  2.7479e-03, -1.1043e-02,  1.6820e-03, -8.5669e-03,
        1.2694e-03,  4.4525e-03, -1.2690e-02,  1.9066e-03,  5.2323e-03,
        5.8080e-03,  8.5452e-03,  3.6153e-05, -1.6958e-02, -1.2980e-02,
        8.8372e-03, -8.5977e-03, -5.9714e-03,  5.5263e-03, -6.2011e-03,
        -1.2598e-02,  1.7239e-03, -4.3963e-03, -2.2388e-03,  2.9121e-03,
        1.6235e-02, -6.3379e-03,  7.2674e-03,  1.7298e-03,  1.1801e-02,
        -1.7498e-02, -1.8339e-02, -7.9902e-04,  1.1260e-02, -2.2013e-03,
        1.4529e-02,  1.0201e-02, -7.9079e-03, -7.3301e-03, -5.2648e-03,
        2.5809e-03, -1.0160e-02,  1.7324e-02,  2.2929e-03,  4.1363e-03,
        -1.8203e-03, -1.4399e-03,  3.0207e-03, -1.4282e-02, -1.4859e-02,
        1.5763e-04, -1.1507e-02, -5.4306e-03,  1.4394e-02,  7.1215e-03,
        7.5245e-04,  1.2570e-02,  1.1300e-03, -2.3292e-03, -9.6025e-03,
        5.9678e-03, -1.7275e-02,  5.5973e-03,  1.5008e-03, -7.9663e-03,
        -8.0280e-03,  5.7592e-03, -1.3230e-02, -8.2239e-03,  2.2626e-03,
        8.1192e-03, -5.1489e-05,  4.2694e-03, -7.4514e-03, -4.1249e-03,
        -8.0771e-03, -2.6722e-03, -1.2477e-02,  1.7695e-03,  3.1197e-04,
        -3.9191e-03,  5.3806e-03, -5.4086e-03, -1.9949e-02,  8.5008e-03,
        8.1793e-03,  4.4004e-03,  7.2492e-04, -1.4310e-02, -1.0314e-02,
        3.2957e-03,  1.0393e-04, -3.9220e-03,  1.5991e-02,  1.3799e-03,
        6.2671e-03,  3.7742e-03,  5.8839e-03,  1.2226e-03, -5.8550e-03,
        -1.6242e-02, -4.6316e-03, -1.3484e-02, -8.9989e-03, -4.7459e-04,
        5.7019e-03,  9.5214e-03, -4.7693e-03,  1.2359e-02, -3.2113e-03,
        7.4007e-03,  3.8718e-03,  1.9313e-04, -8.5847e-05, -4.0087e-03,
        -2.1550e-03,  4.8936e-03,  1.9627e-03, -1.9694e-02, -4.3090e-03,
        1.0197e-02,  9.1722e-03,  2.0254e-03, -2.5325e-03, -5.4694e-03,
        -1.5716e-02,  1.2401e-03,  9.0511e-04,  1.0689e-02, -1.3818e-03,
        -1.7211e-03, -3.1243e-03, -1.8217e-02, -5.9788e-03,  1.6706e-03,
        1.5755e-03,  1.2467e-02,  3.7459e-03, -5.2582e-03,  2.0117e-03,
        1.6675e-02,  1.4236e-02,  2.6192e-03,  1.1884e-02, -5.1248e-04,
        -1.0401e-03, -4.7287e-03,  4.8131e-03, -1.8929e-05,  3.4035e-03,
        1.6172e-02, -4.0935e-03,  1.8113e-03,  2.1257e-02, -1.2091e-03,
        1.3943e-04, -3.8267e-03,  2.2029e-03, -5.6691e-03, -1.4794e-04,
        4.0543e-05, -2.9341e-03, -4.5355e-03,  6.6832e-03,  2.0869e-02,
        -2.3335e-02,  6.3507e-03,  2.1044e-04, -2.8030e-03, -8.8646e-03,
        9.4434e-03, -3.7360e-03, -1.4233e-02,  1.2009e-03, -1.2412e-02,
        8.6193e-03,  2.3621e-03,  9.2802e-03,  2.8975e-03, -1.0630e-02,
        -1.3402e-02,  2.6146e-02, -4.4324e-03, -2.9439e-03,  2.8298e-03,
        -8.8711e-03,  6.1780e-04,  1.5983e-02,  1.6677e-03,  3.8481e-03,
        -1.6531e-02,  1.2274e-02, -2.5816e-03,  8.8967e-03, -4.8722e-03,
        -6.5742e-03,  1.0454e-02,  4.0878e-03,  4.6893e-03,  9.0270e-03,
        2.8767e-03,  2.7505e-03, -2.8669e-04, -7.4599e-03,  1.8388e-04,
        -1.4939e-03, -7.5892e-03, -6.4918e-04,  5.3663e-04,  3.0753e-03,
        1.0855e-02, -8.4266e-04,  1.6654e-03,  1.3610e-02,  7.3313e-04,
        -5.6062e-03,  3.8173e-03,  5.6876e-03, -1.3710e-04, -9.1370e-03,
        -6.3609e-03, -1.4027e-02,  1.6917e-02, -1.7411e-03,  1.4715e-02,
        -8.5485e-03, -4.3225e-04,  5.7140e-03,  6.9674e-03, -5.6322e-03,
        -3.6362e-03,  4.5843e-03, -1.3959e-02, -1.6063e-02,  1.8512e-03,
        -1.2314e-02,  1.3943e-02,  2.5980e-03, -1.8464e-03, -1.2093e-03,
        -2.5367e-03,  8.3252e-03,  1.1078e-02, -1.5850e-02,  8.6851e-03,
        1.0877e-02,  4.1188e-03, -3.6878e-03, -2.4422e-03, -1.7540e-02,
        -2.0604e-03,  6.6689e-03,  9.2843e-03,  2.3915e-03)))

    val imageInfo = Tensor[Float](T(10, 15))
    val bbox = Tensor[Float](T(T(1.0f,  3.0f,  2.0f,  6.0f), T(3.0f,  5.0f,  6.0f, 10.0f)))

    val priorBoxes: Tensor[Float] = bbox // .select(1, 1)
    val priorVariances: Tensor[Float] = input2
    val isClipBoxes: Boolean = false
    val bboxes: Tensor[Float] = input2 // .select(1, 1)
    val varianceEncodedInTarget: Boolean = false
    val output: Tensor[Float] = null
    val decodedBoxes = Tensor[Float]().resizeAs(bboxes)

//    BboxUtil.decodeSingleBbox(1, priorBoxes, priorVariances,
//      isClipBoxes, bbox, varianceEncodedInTarget, decodedBoxes)

    BboxUtil.decodeSignalBoxNew(bboxes.select(1, 1), priorBoxes.select(1, 1),
      Tensor[Float](T(1.0f, 1.0f, 1.0f, 1.0f)), decodedBoxes.select(1, 1))

    BboxUtil.decode(bboxes, priorBoxes, Tensor[Float](T(1.0f, 1.0f, 1.0f, 1.0f)), decodedBoxes)

    val expectedOutput = Tensor[Float](T(
      T(1.0039,  2.9863,  2.0015,  6.0009,  0.9998,  3.0044,  2.0067,  6.0066,
      1.0014,  2.9962,  1.9995,  5.9841,  1.0022,  2.9961,  1.9987,  5.9954,
      1.0009,  2.9999,  2.0008,  6.0019,  1.0006,  2.9964,  2.0009,  6.0073,
      1.0049,  2.9970,  2.0038,  5.9926,  0.9970,  2.9902,  1.9971,  6.0044,
      1.0002,  2.9949,  2.0036,  5.9947,  0.9998,  2.9968,  2.0010,  6.0020,
      0.9983,  3.0034,  1.9934,  6.0105,  1.0039,  3.0058,  1.9973,  6.0013,
      1.0029,  3.0047,  2.0035,  5.9989,  1.0037,  3.0003,  2.0036,  5.9996,
      0.9958,  3.0027,  2.0010,  5.9997,  1.0030,  3.0130,  2.0020,  5.9971,
      0.9985,  2.9957,  2.0012,  5.9975,  0.9996,  3.0009,  1.9989,  6.0049,
      0.9995,  3.0020,  1.9960,  6.0013,  0.9998,  2.9946,  2.0004,  5.9998,
      1.0023,  3.0100,  2.0008,  5.9971,  1.0002,  3.0070,  1.9972,  6.0050,
      1.0039,  2.9987,  1.9977,  6.0009,  0.9982,  2.9919,  1.9984,  6.0044,
      0.9977,  2.9985,  2.0003,  6.0099,  0.9961,  2.9865,  1.9965,  5.9981,
      0.9969,  3.0103,  2.0022,  6.0027,  0.9981,  3.0035,  1.9993,  5.9957,
      1.0019,  3.0039,  2.0039,  6.0009,  1.0035,  3.0084,  1.9973,  5.9950,
      1.0001,  2.9889,  1.9974,  6.0021,  0.9982,  2.9994,  2.0038,  5.9996,
      0.9990,  3.0056,  2.0007,  5.9870,  1.0033,  3.0037,  1.9993,  5.9981,
      1.0040,  2.9947,  1.9986,  5.9964,  1.0000,  3.0021,  2.0023,  5.9970,
      0.9987,  2.9978,  1.9984,  5.9903,  1.0009,  2.9983,  1.9983,  6.0009,
      0.9970,  2.9864,  2.0012,  5.9984,  1.0043,  3.0032,  1.9974,  5.9981,
      0.9998,  2.9947,  1.9987,  6.0082,  0.9989,  2.9984,  1.9999,  6.0041,
      1.0043,  2.9987,  1.9971,  5.9956,  0.9982,  2.9941,  1.9968,  5.9969,
      0.9992,  3.0016,  2.0049,  5.9955,  1.0019,  2.9996,  2.0010,  5.9988,
      0.9983,  2.9976,  2.0002,  6.0018,  0.9947,  2.9976,  1.9972,  6.0008,
      1.0002,  3.0067,  2.0004,  5.9925,  0.9971,  2.9993,  2.0026,  5.9999,
      1.0034,  3.0039,  1.9964,  5.9968,  0.9989,  2.9994,  2.0026,  6.0030,
      0.9954,  2.9964,  2.0023,  6.0062,  1.0011,  3.0052,  2.0001,  6.0047,
      0.9991,  2.9997,  1.9985,  6.0018,  1.0026,  2.9891,  2.0040,  6.0099,
      1.0005,  2.9989,  1.9995,  6.0063,  0.9984,  3.0030,  1.9990,  6.0014,
      0.9951,  3.0133,  2.0038,  5.9937,  1.0019,  3.0039,  2.0006,  5.9968,
      1.0035,  3.0015,  1.9993,  5.9991,  0.9964,  3.0006,  1.9985,  6.0068,
      1.0028,  2.9863,  1.9981,  6.0070,  0.9985,  3.0043,  1.9991,  5.9934,
      1.0011,  3.0055,  2.0014,  6.0100,  0.9974,  3.0019,  1.9966,  6.0065,
      0.9970,  2.9947,  2.0005,  6.0008,  1.0003,  3.0015,  2.0011,  6.0048,
      1.0013,  2.9963,  1.9998,  5.9960,  0.9986,  2.9973,  1.9978,  6.0004,
      1.0019,  2.9931,  2.0033,  6.0031,  0.9999,  2.9974,  2.0006,  5.9995,
      1.0017,  3.0026,  1.9988,  5.9908,  0.9990,  3.0005,  2.0066,  5.9971,
      0.9991,  3.0031,  1.9999,  6.0006,  1.0033,  3.0075,  1.9955,  5.9958,
      0.9968,  2.9926,  2.0035,  5.9967,  1.0007,  2.9974,  1.9994,  6.0067,
      0.9998,  2.9907,  2.0047,  5.9995,  1.0009,  3.0068,  2.0004,  5.9901,
      0.9987,  3.0018,  2.0016,  6.0037),
      T( 3.0070,  4.9762,  6.0031,  9.9983,  2.9995,  5.0025,  6.0120, 10.0068,
        3.0020,  4.9937,  5.9994,  9.9784,  3.0030,  4.9943,  5.9988,  9.9908,
        3.0011,  5.0032,  6.0031, 10.0051,  3.0002,  4.9939,  6.0023, 10.0142,
        3.0085,  4.9939,  6.0080,  9.9859,  2.9949,  4.9887,  5.9977, 10.0069,
        2.9999,  4.9906,  6.0046,  9.9927,  3.0007,  4.9960,  6.0048, 10.0042,
        2.9996,  5.0048,  5.9879, 10.0139,  3.0094,  5.0078,  5.9958, 10.0018,
        3.0085,  5.0077,  6.0068,  9.9992,  3.0089,  4.9974,  6.0053,  9.9996,
        2.9904,  5.0053,  6.0013,  9.9955,  3.0066,  5.0165,  6.0048,  9.9935,
        2.9969,  4.9951,  6.0038,  9.9926,  2.9991,  5.0042,  5.9988, 10.0075,
        2.9990,  5.0002,  5.9922, 10.0018,  3.0010,  4.9892,  6.0025,  9.9955,
        3.0023,  5.0153,  6.0023,  9.9950,  2.9982,  5.0089,  5.9914, 10.0017,
        3.0072,  4.9952,  5.9972,  9.9973,  2.9971,  4.9889,  5.9994, 10.0084,
        2.9968,  4.9973,  5.9982, 10.0114,  2.9933,  4.9822,  5.9927,  9.9958,
        2.9950,  5.0135,  6.0032, 10.0040,  2.9960,  5.0029,  5.9981,  9.9908,
        3.0053,  5.0025,  6.0086, 10.0003,  3.0051,  5.0107,  5.9937,  9.9929,
        3.0022,  4.9844,  5.9979, 10.0017,  2.9978,  4.9998,  6.0079, 10.0011,
        2.9967,  5.0046,  6.0015,  9.9839,  3.0054,  5.0057,  5.9991,  9.9961,
        3.0056,  4.9907,  5.9990,  9.9934,  3.0015,  5.0044,  6.0050,  9.9955,
        2.9994,  5.0026,  5.9973,  9.9877,  3.0023,  4.9970,  5.9991, 10.0034,
        2.9944,  4.9831,  6.0012,  9.9929,  3.0075,  5.0066,  5.9960,  9.9943,
        3.0029,  4.9905,  5.9998, 10.0097,  2.9990,  5.0002,  6.0021, 10.0073,
        3.0070,  4.9993,  5.9940,  9.9937,  2.9948,  4.9912,  5.9944,  9.9980,
        2.9989,  4.9991,  6.0088,  9.9952,  3.0029,  5.0024,  6.0030, 10.0023,
        2.9964,  4.9975,  6.0004,  9.9999,  2.9880,  4.9919,  5.9962, 10.0029,
        3.0030,  5.0079,  5.9986,  9.9891,  2.9962,  5.0014,  6.0048,  9.9997,
        3.0066,  5.0017,  5.9920,  9.9945,  2.9957,  4.9987,  6.0057, 10.0032,
        2.9912,  4.9927,  6.0046, 10.0098,  3.0013,  5.0078,  6.0008, 10.0065,
        2.9981,  5.0008,  5.9981, 10.0049,  3.0057,  4.9848,  6.0072, 10.0103,
        3.0010,  4.9988,  5.9980, 10.0014,  2.9977,  5.0017,  5.9977,  9.9982,
        2.9898,  5.0180,  6.0066,  9.9900,  3.0037,  5.0054,  6.0014,  9.9948,
        3.0095,  4.9970,  5.9981,  9.9985,  2.9941,  4.9996,  5.9960, 10.0107,
        3.0065,  4.9779,  5.9958, 10.0094,  2.9971,  5.0036,  5.9994,  9.9929,
        2.9996,  5.0073,  6.0009, 10.0119,  2.9944,  5.0020,  5.9924, 10.0127,
        2.9939,  4.9936,  6.0022,  9.9985,  3.0007,  5.0038,  6.0030, 10.0071,
        2.9998,  4.9964,  6.0000,  9.9946,  2.9967,  4.9978,  5.9972, 10.0015,
        3.0037,  4.9913,  6.0050, 10.0077,  2.9988,  4.9932,  6.0018, 10.0001,
        3.0025,  5.0029,  5.9974,  9.9861,  3.0009,  5.0041,  6.0127,  9.9938,
        2.9970,  5.0068,  6.0026, 10.0001,  3.0041,  5.0124,  5.9930,  9.9931,
        2.9952,  4.9911,  6.0063,  9.9942,  3.0003,  4.9943,  5.9982, 10.0043,
        3.0010,  4.9840,  6.0079,  9.9970,  3.0026,  5.0083,  6.0007,  9.9873,
        2.9955,  5.0026,  6.0029, 10.0054)))

    println("done")
  }

  "filter result" should "be ok" in {
    val input = Tensor[Float](T(
      T(1.0039,  2.9863,  2.0015,  6.0009,  0.9998,  3.0044,  2.0067,  6.0066,
        1.0014,  2.9962,  1.9995,  5.9841,  1.0022,  2.9961,  1.9987,  5.9954,
        1.0009,  2.9999,  2.0008,  6.0019,  1.0006,  2.9964,  2.0009,  6.0073,
        1.0049,  2.9970,  2.0038,  5.9926,  0.9970,  2.9902,  1.9971,  6.0044,
        1.0002,  2.9949,  2.0036,  5.9947,  0.9998,  2.9968,  2.0010,  6.0020,
        0.9983,  3.0034,  1.9934,  6.0105,  1.0039,  3.0058,  1.9973,  6.0013,
        1.0029,  3.0047,  2.0035,  5.9989,  1.0037,  3.0003,  2.0036,  5.9996,
        0.9958,  3.0027,  2.0010,  5.9997,  1.0030,  3.0130,  2.0020,  5.9971,
        0.9985,  2.9957,  2.0012,  5.9975,  0.9996,  3.0009,  1.9989,  6.0049,
        0.9995,  3.0020,  1.9960,  6.0013,  0.9998,  2.9946,  2.0004,  5.9998,
        1.0023,  3.0100,  2.0008,  5.9971,  1.0002,  3.0070,  1.9972,  6.0050,
        1.0039,  2.9987,  1.9977,  6.0009,  0.9982,  2.9919,  1.9984,  6.0044,
        0.9977,  2.9985,  2.0003,  6.0099,  0.9961,  2.9865,  1.9965,  5.9981,
        0.9969,  3.0103,  2.0022,  6.0027,  0.9981,  3.0035,  1.9993,  5.9957,
        1.0019,  3.0039,  2.0039,  6.0009,  1.0035,  3.0084,  1.9973,  5.9950,
        1.0001,  2.9889,  1.9974,  6.0021,  0.9982,  2.9994,  2.0038,  5.9996,
        0.9990,  3.0056,  2.0007,  5.9870,  1.0033,  3.0037,  1.9993,  5.9981,
        1.0040,  2.9947,  1.9986,  5.9964,  1.0000,  3.0021,  2.0023,  5.9970,
        0.9987,  2.9978,  1.9984,  5.9903,  1.0009,  2.9983,  1.9983,  6.0009,
        0.9970,  2.9864,  2.0012,  5.9984,  1.0043,  3.0032,  1.9974,  5.9981,
        0.9998,  2.9947,  1.9987,  6.0082,  0.9989,  2.9984,  1.9999,  6.0041,
        1.0043,  2.9987,  1.9971,  5.9956,  0.9982,  2.9941,  1.9968,  5.9969,
        0.9992,  3.0016,  2.0049,  5.9955,  1.0019,  2.9996,  2.0010,  5.9988,
        0.9983,  2.9976,  2.0002,  6.0018,  0.9947,  2.9976,  1.9972,  6.0008,
        1.0002,  3.0067,  2.0004,  5.9925,  0.9971,  2.9993,  2.0026,  5.9999,
        1.0034,  3.0039,  1.9964,  5.9968,  0.9989,  2.9994,  2.0026,  6.0030,
        0.9954,  2.9964,  2.0023,  6.0062,  1.0011,  3.0052,  2.0001,  6.0047,
        0.9991,  2.9997,  1.9985,  6.0018,  1.0026,  2.9891,  2.0040,  6.0099,
        1.0005,  2.9989,  1.9995,  6.0063,  0.9984,  3.0030,  1.9990,  6.0014,
        0.9951,  3.0133,  2.0038,  5.9937,  1.0019,  3.0039,  2.0006,  5.9968,
        1.0035,  3.0015,  1.9993,  5.9991,  0.9964,  3.0006,  1.9985,  6.0068,
        1.0028,  2.9863,  1.9981,  6.0070,  0.9985,  3.0043,  1.9991,  5.9934,
        1.0011,  3.0055,  2.0014,  6.0100,  0.9974,  3.0019,  1.9966,  6.0065,
        0.9970,  2.9947,  2.0005,  6.0008,  1.0003,  3.0015,  2.0011,  6.0048,
        1.0013,  2.9963,  1.9998,  5.9960,  0.9986,  2.9973,  1.9978,  6.0004,
        1.0019,  2.9931,  2.0033,  6.0031,  0.9999,  2.9974,  2.0006,  5.9995,
        1.0017,  3.0026,  1.9988,  5.9908,  0.9990,  3.0005,  2.0066,  5.9971,
        0.9991,  3.0031,  1.9999,  6.0006,  1.0033,  3.0075,  1.9955,  5.9958,
        0.9968,  2.9926,  2.0035,  5.9967,  1.0007,  2.9974,  1.9994,  6.0067,
        0.9998,  2.9907,  2.0047,  5.9995,  1.0009,  3.0068,  2.0004,  5.9901,
        0.9987,  3.0018,  2.0016,  6.0037),
      T( 3.0070,  4.9762,  6.0031,  9.9983,  2.9995,  5.0025,  6.0120, 10.0068,
        3.0020,  4.9937,  5.9994,  9.9784,  3.0030,  4.9943,  5.9988,  9.9908,
        3.0011,  5.0032,  6.0031, 10.0051,  3.0002,  4.9939,  6.0023, 10.0142,
        3.0085,  4.9939,  6.0080,  9.9859,  2.9949,  4.9887,  5.9977, 10.0069,
        2.9999,  4.9906,  6.0046,  9.9927,  3.0007,  4.9960,  6.0048, 10.0042,
        2.9996,  5.0048,  5.9879, 10.0139,  3.0094,  5.0078,  5.9958, 10.0018,
        3.0085,  5.0077,  6.0068,  9.9992,  3.0089,  4.9974,  6.0053,  9.9996,
        2.9904,  5.0053,  6.0013,  9.9955,  3.0066,  5.0165,  6.0048,  9.9935,
        2.9969,  4.9951,  6.0038,  9.9926,  2.9991,  5.0042,  5.9988, 10.0075,
        2.9990,  5.0002,  5.9922, 10.0018,  3.0010,  4.9892,  6.0025,  9.9955,
        3.0023,  5.0153,  6.0023,  9.9950,  2.9982,  5.0089,  5.9914, 10.0017,
        3.0072,  4.9952,  5.9972,  9.9973,  2.9971,  4.9889,  5.9994, 10.0084,
        2.9968,  4.9973,  5.9982, 10.0114,  2.9933,  4.9822,  5.9927,  9.9958,
        2.9950,  5.0135,  6.0032, 10.0040,  2.9960,  5.0029,  5.9981,  9.9908,
        3.0053,  5.0025,  6.0086, 10.0003,  3.0051,  5.0107,  5.9937,  9.9929,
        3.0022,  4.9844,  5.9979, 10.0017,  2.9978,  4.9998,  6.0079, 10.0011,
        2.9967,  5.0046,  6.0015,  9.9839,  3.0054,  5.0057,  5.9991,  9.9961,
        3.0056,  4.9907,  5.9990,  9.9934,  3.0015,  5.0044,  6.0050,  9.9955,
        2.9994,  5.0026,  5.9973,  9.9877,  3.0023,  4.9970,  5.9991, 10.0034,
        2.9944,  4.9831,  6.0012,  9.9929,  3.0075,  5.0066,  5.9960,  9.9943,
        3.0029,  4.9905,  5.9998, 10.0097,  2.9990,  5.0002,  6.0021, 10.0073,
        3.0070,  4.9993,  5.9940,  9.9937,  2.9948,  4.9912,  5.9944,  9.9980,
        2.9989,  4.9991,  6.0088,  9.9952,  3.0029,  5.0024,  6.0030, 10.0023,
        2.9964,  4.9975,  6.0004,  9.9999,  2.9880,  4.9919,  5.9962, 10.0029,
        3.0030,  5.0079,  5.9986,  9.9891,  2.9962,  5.0014,  6.0048,  9.9997,
        3.0066,  5.0017,  5.9920,  9.9945,  2.9957,  4.9987,  6.0057, 10.0032,
        2.9912,  4.9927,  6.0046, 10.0098,  3.0013,  5.0078,  6.0008, 10.0065,
        2.9981,  5.0008,  5.9981, 10.0049,  3.0057,  4.9848,  6.0072, 10.0103,
        3.0010,  4.9988,  5.9980, 10.0014,  2.9977,  5.0017,  5.9977,  9.9982,
        2.9898,  5.0180,  6.0066,  9.9900,  3.0037,  5.0054,  6.0014,  9.9948,
        3.0095,  4.9970,  5.9981,  9.9985,  2.9941,  4.9996,  5.9960, 10.0107,
        3.0065,  4.9779,  5.9958, 10.0094,  2.9971,  5.0036,  5.9994,  9.9929,
        2.9996,  5.0073,  6.0009, 10.0119,  2.9944,  5.0020,  5.9924, 10.0127,
        2.9939,  4.9936,  6.0022,  9.9985,  3.0007,  5.0038,  6.0030, 10.0071,
        2.9998,  4.9964,  6.0000,  9.9946,  2.9967,  4.9978,  5.9972, 10.0015,
        3.0037,  4.9913,  6.0050, 10.0077,  2.9988,  4.9932,  6.0018, 10.0001,
        3.0025,  5.0029,  5.9974,  9.9861,  3.0009,  5.0041,  6.0127,  9.9938,
        2.9970,  5.0068,  6.0026, 10.0001,  3.0041,  5.0124,  5.9930,  9.9931,
        2.9952,  4.9911,  6.0063,  9.9942,  3.0003,  4.9943,  5.9982, 10.0043,
        3.0010,  4.9840,  6.0079,  9.9970,  3.0026,  5.0083,  6.0007,  9.9873,
        2.9955,  5.0026,  6.0029, 10.0054)))

    val scores = Tensor[Float](
      T(0.0104, 0.0125, 0.0123, 0.0113, 0.0122, 0.0109, 0.0137, 0.0121, 0.0124,
      0.0112, 0.0142, 0.0117, 0.0133, 0.0116, 0.0143, 0.0116, 0.0131, 0.0114,
      0.0150, 0.0124, 0.0129, 0.0118, 0.0122, 0.0128, 0.0121, 0.0122, 0.0135,
      0.0134, 0.0101, 0.0133, 0.0108, 0.0128, 0.0128, 0.0112, 0.0134, 0.0129,
      0.0115, 0.0112, 0.0127, 0.0133, 0.0146, 0.0124, 0.0117, 0.0110, 0.0120,
      0.0116, 0.0129, 0.0122, 0.0109, 0.0107, 0.0119, 0.0107, 0.0131, 0.0146,
      0.0137, 0.0101, 0.0123, 0.0130, 0.0140, 0.0150, 0.0122, 0.0128, 0.0119,
      0.0124, 0.0127, 0.0119, 0.0114, 0.0127, 0.0130, 0.0130, 0.0129, 0.0120,
      0.0119, 0.0137, 0.0120, 0.0131, 0.0108, 0.0121, 0.0120, 0.0104, 0.0119,
      0.0101, 0.0124, 0.0123, 0.0111, 0.0122, 0.0112, 0.0137, 0.0121, 0.0120,
      0.0113, 0.0143, 0.0124, 0.0137, 0.0115, 0.0139, 0.0116, 0.0131, 0.0117,
      0.0148, 0.0124, 0.0132, 0.0118, 0.0125, 0.0121, 0.0123, 0.0116, 0.0132,
      0.0130, 0.0104, 0.0130, 0.0107, 0.0126, 0.0125, 0.0114, 0.0132, 0.0132,
      0.0112, 0.0116, 0.0129, 0.0137, 0.0132, 0.0120, 0.0112, 0.0115, 0.0118,
      0.0116, 0.0128, 0.0128, 0.0115, 0.0106, 0.0121, 0.0104, 0.0134, 0.0142,
      0.0132, 0.0106, 0.0118, 0.0130, 0.0140, 0.0149, 0.0119, 0.0130, 0.0118,
      0.0122, 0.0130, 0.0119, 0.0114, 0.0124, 0.0127, 0.0131, 0.0134, 0.0117,
      0.0121, 0.0139, 0.0120, 0.0132, 0.0113, 0.0133, 0.0126, 0.0107, 0.0114))

    val imgInfo = Tensor[Float](T(10, 15))

    val score_thresh: Float = 0.05f
    val nms_thresh: Float = 0.5f
    val detections_per_img: Int = 100
    val cls_agnostic_bbox_reg: Boolean = false
    val bbox_aug_enabled: Boolean = false

    val layer = new FPNPostProcessor(score_thresh, nms_thresh, detections_per_img,
      cls_agnostic_bbox_reg, bbox_aug_enabled)

    val num_classes = 81
    val fun = layer.filterResults(input, scores, num_classes)

    println("done")
  }
}
